<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload Document / Location Selfie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../config.js"></script>
  <style>
    :root{--bg1:#f5d1ff;--bg2:#c1eaff;--card:linear-gradient(145deg,#fff,#f0f8ff);
      --accent:#5e35b1;--btn:linear-gradient(145deg,#f271c4,#aa52f2);--text:#333}
    *{box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0}
    body{min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));
      display:grid;grid-template-columns:260px 1fr}
    .sidebar{position:sticky;top:0;height:100vh;padding:1rem;background:var(--card);
      border-right:1px solid rgba(0,0,0,.05);box-shadow:0 10px 25px rgba(0,0,0,.08)}
    .brand{display:flex;align-items:center;gap:.6rem;margin-bottom:1rem}
    .logo{width:40px;height:40px;border-radius:12px;background:var(--btn);box-shadow:0 6px 14px rgba(0,0,0,.15)}
    .brand h1{font-size:1.1rem;color:var(--accent);text-shadow:1px 1px 0 #fff}
    .nav{display:grid;gap:.4rem;margin-top:.5rem}
    .nav a{display:block;text-decoration:none;color:var(--text);font-weight:600;padding:.75rem .9rem;border-radius:.9rem;transition:.12s}
    .nav a:hover{background:#eef3ff;transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.06)}
    .logout{color:#b00020!important}

    .main{padding:1.2rem;display:grid;gap:1rem;align-content:start;min-width:0;overflow:auto}
    .header{background:var(--card);border-radius:1.6rem;padding:1rem 1.25rem;box-shadow:0 10px 25px rgba(0,0,0,.15);
      display:flex;justify-content:space-between;align-items:center;gap:.75rem;flex-wrap:wrap}
    .header h2{color:var(--accent);font-size:1.3rem;text-shadow:1px 1px 0 #fff}
    .pill{padding:.35rem .75rem;border-radius:999px;background:#f0e7ff;color:var(--accent);font-weight:600;font-size:.9rem}

    .grid{display:grid;gap:1rem;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 12;background:var(--card);border-radius:1.2rem;padding:1rem 1.25rem;box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .card h3{font-size:1.05rem;color:var(--accent);margin-bottom:.6rem}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
    .input, textarea, select{
      background:#fff;border:none;border-radius:12px;padding:.6rem .75rem;min-width:200px;
      box-shadow:inset 2px 2px 6px #d1d9e6,inset -2px -2px 6px #fff
    }
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;background:var(--btn);color:#fff;border:0;border-radius:999px;padding:.65rem 1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.2);transition:.12s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(0,0,0,.25)}
    .muted{color:#666}

    .list{display:grid;gap:.6rem}
    .item{display:grid;grid-template-columns:auto 1fr auto;gap:.6rem;align-items:center;border:1px solid #eef;border-radius:12px;padding:.6rem;background:#f9fbff}
    .thumb{width:72px;height:72px;border-radius:12px;object-fit:cover;background:#fff;display:grid;place-items:center;border:1px solid #eee}
    .thumb span{font-size:.9rem;color:#555}
    .meta{font-size:.92rem;color:#444}
    .meta .desc{font-weight:700}
    .actions{display:flex;gap:.4rem}

    @media (max-width:980px){
      body{grid-template-columns:1fr}
      .sidebar{position:fixed;left:0;top:0;transform:translateX(-100%);transition:transform .2s ease;z-index:20;width:260px}
      .sidebar.open{transform:translateX(0)}
      .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:15}
      .overlay.show{display:block}
      .item{grid-template-columns:1fr}
      .thumb{width:100%;height:180px}
      .actions{justify-content:flex-end}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand"><div class="logo"></div><h1>BrokerBuddy</h1></div>
    <nav class="nav">
      <a href="./telecaller_dashboard.html">üè† Dashboard</a>
      <a href="./telecaller.html">‚ñ∂ Start Calling</a>
      <a href="./callback_leads.html">‚è∞ CallBack Leads</a>
      <a href="./svs_leads.html">üìç SVS Leads</a>
      <a href="./my_leads.html">üë§ My Leads</a>
      <a href="./upload_docs.html"><strong>üì∑ Upload Document/Location Selfie</strong></a>
      <a href="./add_project.html">‚ûï Add Projects</a>
      <a href="./projects.html">üèóÔ∏è View Active Projects</a>
      <a href="./payslips.html">üíº Download PaySlips</a>
      <a class="logout" href="/logout">‚á¶ Logout</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <section class="header">
      <h2>Upload Document / Location Selfie</h2>
      <span class="pill" id="tcInfo"></span>
    </section>

    <section class="grid">
      <!-- Document upload -->
      <div class="card" style="grid-column:span 12">
        <h3>Upload Document (PDF / Image)</h3>
        <div class="row" style="margin:.4rem 0 .6rem">
          <input type="file" id="docFile" class="input" accept=".pdf,image/*">
          <input type="text" id="docDesc" class="input" placeholder="Description (required)">
          <label><input type="checkbox" id="docWithLoc"> Attach my current location</label>
          <button class="btn" id="docUploadBtn">Upload</button>
        </div>
        <p class="muted" id="docMsg"></p>
      </div>

      <!-- Selfie upload -->
      <div class="card" style="grid-column:span 12">
        <h3>Upload Location Selfie (uses camera)</h3>
        <div class="row" style="margin:.4rem 0 .6rem">
          <input type="file" id="selfieFile" class="input" accept="image/*" capture="environment">
          <input type="text" id="selfieDesc" class="input" placeholder="Description (required)">
          <label><input type="checkbox" id="selfieWithLoc" checked> Attach my current location</label>
          <button class="btn" id="selfieUploadBtn">Upload</button>
        </div>
        <p class="muted" id="selfieMsg"></p>
      </div>

      <!-- List -->
      <div class="card" style="grid-column:span 12">
        <h3>My Uploads</h3>
        <div class="row" style="margin:.4rem 0 .6rem">
          <select id="filterKind" class="input" style="min-width:160px">
            <option value="">All</option>
            <option value="document">Documents</option>
            <option value="selfie">Selfies</option>
          </select>
          <input type="date" id="filterDate" class="input">
          <input type="text" id="filterQ" class="input" placeholder="Search description...">
          <button class="btn" id="refreshBtn">Refresh</button>
        </div>
        <div class="list" id="list"></div>
        <p class="muted" id="empty" style="display:none">No uploads yet.</p>
      </div>
    </section>
  </main>

  <script>
    const url = new URLSearchParams(location.search);
    const telecallerId = parseInt(url.get("telecallerId")) || parseInt(localStorage.getItem("telecallerId")) || 3;
    localStorage.setItem("telecallerId", telecallerId);
    document.getElementById("tcInfo").textContent = `Telecaller #${telecallerId}`;

    // Shortcuts
    const docFile = document.getElementById("docFile");
    const docDesc = document.getElementById("docDesc");
    const docWithLoc = document.getElementById("docWithLoc");
    const docMsg = document.getElementById("docMsg");
    const docUploadBtn = document.getElementById("docUploadBtn");

    const selfieFile = document.getElementById("selfieFile");
    const selfieDesc = document.getElementById("selfieDesc");
    const selfieWithLoc = document.getElementById("selfieWithLoc");
    const selfieMsg = document.getElementById("selfieMsg");
    const selfieUploadBtn = document.getElementById("selfieUploadBtn");

    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");
    const filterKind = document.getElementById("filterKind");
    const filterDate = document.getElementById("filterDate");
    const filterQ = document.getElementById("filterQ");
    const refreshBtn = document.getElementById("refreshBtn");

    function fmt(z) { try { return new Date(z).toLocaleString(); } catch { return z || ""; } }

    function getLocationIfNeeded(checked){
      return new Promise((resolve) => {
        if (!checked || !("geolocation" in navigator)) return resolve(null);
        const opts = { enableHighAccuracy: true, maximumAge: 10_000, timeout: 12_000 };
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          _   => resolve(null),
          opts
        );
      });
    }

    async function doUpload(kind, fileInput, descInput, withLoc, msgEl){
      msgEl.textContent = "";
      const file = fileInput.files?.[0];
      const description = (descInput.value || "").trim();
      if (!file) { msgEl.textContent = "Please choose a file."; return; }
      if (!description) { msgEl.textContent = "Please add a description."; return; }

      const loc = await getLocationIfNeeded(withLoc.checked);
      const fd = new FormData();
      fd.append("telecaller_id", String(telecallerId));
      fd.append("description", description);
      fd.append("kind", kind); // "document" or "selfie"
      fd.append("file", file);
      if (loc){ fd.append("lat", String(loc.lat)); fd.append("lng", String(loc.lng)); }

      try{
        const res = await fetch("/telecaller/upload", { method: "POST", body: fd });
        if (!res.ok) throw new Error("Upload failed");
        const item = await res.json();
        msgEl.textContent = "‚úÖ Uploaded";
        // reset inputs
        fileInput.value = "";
        descInput.value = "";
        await loadList();
      }catch(e){
        console.error(e);
        msgEl.textContent = "‚ùå Upload failed";
      }
    }

    docUploadBtn.onclick = () => doUpload("document", docFile, docDesc, docWithLoc, docMsg);
    selfieUploadBtn.onclick = () => doUpload("selfie", selfieFile, selfieDesc, selfieWithLoc, selfieMsg);

    function renderList(items){
      listEl.innerHTML = "";
      if (!items.length){ emptyEl.style.display = "block"; return; }
      emptyEl.style.display = "none";

      for (const x of items){
        const isImg = (x.mime || "").startsWith("image/");
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="thumb">
            ${
              isImg
              ? `<img src="${x.url}" alt="thumb" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`
              : `<a href="${x.url}" target="_blank" style="text-decoration:none"><span>üìÑ PDF</span></a>`
            }
          </div>
          <div class="meta">
            <div class="desc">${x.description || "(no description)"}</div>
            <div>Type: <strong>${x.kind}</strong> ‚Ä¢ Size: ${(x.size/1024).toFixed(1)} KB</div>
            <div>When: ${fmt(x.created_at)}</div>
            ${
              (x.lat!=null && x.lng!=null)
              ? `<div>Location: ${x.lat.toFixed(5)}, ${x.lng.toFixed(5)}</div>`
              : `<div class="muted">No location</div>`
            }
          </div>
          <div class="actions">
            <a class="btn" href="${x.url}" target="_blank">üîç View</a>
            <button class="btn" data-del="${x.id}">üóëÔ∏è Delete</button>
          </div>
        `;
        listEl.appendChild(div);
      }
    }

    async function loadList(){
      const qs = new URLSearchParams();
      if (filterKind.value) qs.set("kind", filterKind.value);
      if (filterQ.value.trim()) qs.set("q", filterQ.value.trim());
      if (filterDate.value) qs.set("date_on", filterDate.value);
      const res = await fetch(`/telecaller/uploads/${telecallerId}?` + qs.toString());
      if (!res.ok){ listEl.innerHTML = "<p class='muted'>Failed to load uploads.</p>"; return; }
      const items = await res.json();
      renderList(items);
    }

    listEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-del]");
      if (!btn) return;
      const id = btn.getAttribute("data-del");
      if (!confirm("Delete this upload?")) return;
      const res = await fetch(`/telecaller/upload/${telecallerId}/${id}`, { method: "DELETE" });
      if (!res.ok){ alert("Failed to delete"); return; }
      loadList();
    });

    refreshBtn.onclick = loadList;
    filterKind.onchange = loadList;
    filterDate.onchange = loadList;
    filterQ.oninput = () => { clearTimeout(window._t); window._t = setTimeout(loadList, 250); };

    // Init
    loadList();
  </script>
</body>
</html>

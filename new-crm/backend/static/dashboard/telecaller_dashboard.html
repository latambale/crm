<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Telecaller Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../config.js"></script>
  <style>
    :root{
      --bg1:#f5d1ff;--bg2:#c1eaff;--card-grad:linear-gradient(145deg,#ffffff,#f0f8ff);
      --accent:#5e35b1;--btn-grad:linear-gradient(145deg,#f271c4,#aa52f2);--text-dark:#333;
    }
    *{box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0}
    body{
      min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));
      display:grid;grid-template-columns:260px 1fr
    }
    /* Sidebar */
    .sidebar{position:sticky;top:0;height:100vh;padding:1rem;background:var(--card-grad);
      border-right:1px solid rgba(0,0,0,.05);box-shadow:0 10px 25px rgba(0,0,0,.08)}
    .brand{display:flex;align-items:center;gap:.6rem;margin-bottom:1rem}
    .brand .logo{width:40px;height:40px;border-radius:12px;background:var(--btn-grad);
      box-shadow:0 6px 14px rgba(0,0,0,.15)}
    .brand h1{font-size:1.1rem;color:var(--accent);text-shadow:1px 1px 0 #fff}
    .nav{display:grid;gap:.4rem;margin-top:.5rem}
    .nav a{display:block;text-decoration:none;color:var(--text-dark);font-weight:600;
      padding:.75rem .9rem;border-radius:.9rem;transition:.12s;cursor:pointer}
    .nav a:hover{background:#eef3ff;transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.06)}
    .logout{color:#b00020!important}

    /* Mobile */
    .topbar{display:none;position:sticky;top:0;z-index:10;padding:.75rem 1rem;background:var(--btn-grad);color:#fff}
    .menu-toggle{background:transparent;border:0;color:inherit;font-size:1.25rem;cursor:pointer}

    /* Main */
    .main{
      padding:1.2rem;display:grid;gap:1rem;align-content:start;
      min-width:0;               /* üîß desktop fix */
      overflow:auto;             /* üîß desktop fix */
    }
    .header{background:var(--card-grad);border-radius:1.6rem;padding:1rem 1.25rem;
      box-shadow:0 10px 25px rgba(0,0,0,.15);display:flex;justify-content:space-between;align-items:center;gap:.75rem;flex-wrap:wrap}
    .header h2{color:var(--accent);font-size:1.3rem;text-shadow:1px 1px 0 #fff}
    .pill{padding:.35rem .75rem;border-radius:999px;background:#f0e7ff;color:var(--accent);font-weight:600;font-size:.9rem}

    .grid{display:grid;gap:1rem;grid-template-columns:repeat(12,1fr);min-width:0} /* üîß desktop fix */
    .card{grid-column:span 12;background:var(--card-grad);border-radius:1.6rem;padding:1rem 1.25rem;
      box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .card h3{font-size:1.05rem;color:var(--accent);margin-bottom:.6rem}
    .muted{color:#555;font-size:.93rem}

    .actions{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.6rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;background:var(--btn-grad);color:#fff;
      border:0;border-radius:999px;padding:.7rem 1rem;font-weight:700;cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.2);transition:.12s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(0,0,0,.25)}
    .btn[disabled]{opacity:.65;cursor:not-allowed}
    .stat-row{display:flex;gap:1rem;flex-wrap:wrap;margin-top:.8rem}
    .stat{background:#f0f4ff;border-radius:12px;padding:.6rem .8rem;font-weight:600;color:#444;
      box-shadow:inset 4px 4px 10px #d1d9e6,inset -4px -4px 10px #ffffff}

    .filters{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.5rem}
    .input,select{background:#fff;border:none;border-radius:12px;padding:.6rem .75rem;min-width:180px;
      box-shadow:inset 2px 2px 6px #d1d9e6,inset -2px -2px 6px #ffffff}

    @media (max-width:980px){
      body{grid-template-columns:1fr}
      .topbar{display:flex;justify-content:space-between;align-items:center}
      .sidebar{position:fixed;left:0;top:0;transform:translateX(-100%);transition:transform .2s ease;z-index:20;width:260px}
      .sidebar.open{transform:translateX(0)}
      .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:15}
      .overlay.show{display:block}
      .main{padding-top:.5rem}
    }

    /* Inline message */
    #ui-msg{margin-top:.5rem;font-weight:600}
    #ui-msg.error{color:#b00020}
    #ui-msg.note{color:#5e35b1}
  </style>
</head>
<body>
  <!-- Topbar (mobile) -->
  <div class="topbar">
    <button class="menu-toggle" id="menuToggle">‚ò∞</button>
    <div>Telecaller Dashboard</div>
    <span></span>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <h1>BrokerBuddy</h1>
    </div>
    <nav class="nav">
      <a href="./telecaller.html">‚ñ∂ Start Calling</a>
      <a href="./callback_leads.html">‚è∞ CallBack Leads List</a>
      <a href="./svs_leads.html">üìç SVS Leads</a>
      <a href="./my_leads.html">üë§ My Leads</a>
      <a href="./upload_docs.html">üì∑ Upload Document/Location Selfie</a>
      <a href="./add_project.html">‚ûï Add Projects</a>
      <a href="./projects.html">üèóÔ∏è View Active Projects</a>
      <a href="./payslips.html">üíº Download PaySlips</a>
      <a class="logout" href="/logout">‚á¶ Logout</a>
    </nav>
  </aside>
  <div class="overlay" id="overlay"></div>

  <!-- Main -->
  <main class="main">
    <section class="header">
      <h2>Welcome back, <span id="tcName">Telecaller</span></h2>
      <span class="pill" id="todayDate"></span>
    </section>

    <!-- Today's Actions -->
    <section class="grid">
      <div class="card">
        <h3>Today's Actions</h3>
        <p class="muted">Mark your presence and share your current location for today‚Äôs shift.</p>
        <div class="actions">
          <button class="btn" id="btnAttendance">‚úÖ Add Attendance for Today</button>
          <button class="btn" id="btnLocation">üìç Share Live Location</button>
        </div>
        <div id="ui-msg" class="note"></div>
        <div class="stat-row">
          <div class="stat" id="attendanceStatus">Attendance: not marked</div>
          <div class="stat" id="locationStatus">Location: not shared</div>
          <div class="stat" id="hoursStatus">Hours Today: 0h 00m</div>
        </div>
      </div>

      <!-- Quick Filters -->
      <div class="card">
        <h3>Quick Filters</h3>
        <div class="filters">
          <select id="leadStageFilter">
            <option value="">Stage (all)</option>
            <option value="connected">Connected</option>
            <option value="warm">Warm</option>
            <option value="hot">Hot</option>
            <option value="svs">SVS</option>
            <option value="converted">Converted</option>
            <option value="not_connected">Not Connected</option>
          </select>
          <input class="input" id="searchBox" placeholder="Search by name/phone..." />
          <button class="btn" id="openMyLeads">Open My Leads</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const telecallerId = parseInt(urlParams.get("telecallerId")) || parseInt(localStorage.getItem("telecallerId")) || 3;
      localStorage.setItem("telecallerId", telecallerId);

      // Elements
      const tcNameEl         = document.getElementById("tcName");
      const todayDateEl      = document.getElementById("todayDate");
      const uiMsg            = document.getElementById("ui-msg");
      const btnAttendance    = document.getElementById("btnAttendance");
      const btnLocation      = document.getElementById("btnLocation");
      const attendanceStatus = document.getElementById("attendanceStatus");
      const locationStatus   = document.getElementById("locationStatus");
      const hoursStatus      = document.getElementById("hoursStatus");
      const openMyLeadsBtn   = document.getElementById("openMyLeads");
      const stageFilter      = document.getElementById("leadStageFilter");
      const searchBox        = document.getElementById("searchBox");
      const menuToggle       = document.getElementById("menuToggle");
      const sidebar          = document.getElementById("sidebar");
      const overlay          = document.getElementById("overlay");

      // Header text
      tcNameEl.textContent = localStorage.getItem("telecallerName") || "Telecaller";
      todayDateEl.textContent = new Date().toLocaleDateString();

      // Mobile sidebar
      if (menuToggle && sidebar && overlay) {
        menuToggle.addEventListener("click", () => { sidebar.classList.toggle("open"); overlay.classList.toggle("show"); });
        overlay.addEventListener("click", () => { sidebar.classList.remove("open"); overlay.classList.remove("show"); });
      }

      // HTTPS note for geolocation
      if (!(location.protocol === "https:" || location.hostname === "localhost" || location.hostname === "127.0.0.1")) {
        uiMsg.className = "note";
        uiMsg.textContent = "Tip: Share Live Location works only on HTTPS or localhost.";
      }

      // ---- Hours helpers ----
      let hoursTimerId = null;
      function formatHM(totalSeconds){
        const h = Math.floor(totalSeconds / 3600);
        const m = Math.floor((totalSeconds % 3600) / 60);
        return `${h}h ${String(m).padStart(2,"0")}m`;
      }
      function clearHoursTimer(){ if (hoursTimerId){ clearInterval(hoursTimerId); hoursTimerId = null; } }
      function startLiveTimerFrom(inIso) {
      clearHoursTimer();
      if (!inIso) { hoursStatus.textContent = "Hours Today: --"; return; }
      // Ensure it's parsed as UTC
      const iso = inIso.endsWith("Z") ? inIso : inIso + "Z";
      const startMs = Date.parse(iso);
      if (isNaN(startMs)) { hoursStatus.textContent = "Hours Today: --"; return; }
      const tick = () => {
        const secs = Math.max(0, Math.floor((Date.now() - startMs) / 1000));
        hoursStatus.textContent = `Hours Today: ${formatHM(secs)} (live)`;
      };
      tick();
      hoursTimerId = setInterval(tick, 30000);
    }


      async function refreshTodayHours(){
        try{
          const resp = await fetch(`/telecaller/attendance/today/${telecallerId}`);
          if (!resp.ok) throw new Error("attendance fetch failed");
          const a = await resp.json();

          if (a.status === "not_marked"){
            clearHoursTimer();
            hoursStatus.textContent = "Hours Today: 0h 00m";
            attendanceStatus.textContent = "Attendance: not marked";
            btnAttendance.disabled = false;
            btnAttendance.textContent = "‚úÖ Add Attendance for Today";
            return;
          }
          if (a.status === "clocked_in" || a.status === "already_marked"){
            attendanceStatus.textContent = `Attendance: clocked in at ${new Date(a.in_time).toLocaleTimeString()}`;
            startLiveTimerFrom(a.in_time);
            btnAttendance.disabled = true;                             // üîí lock after marked
            btnAttendance.textContent = "‚úÖ Attendance Marked";
            return;
          }
          if (a.status === "clocked_out"){
            clearHoursTimer();
            attendanceStatus.textContent = `Attendance: clocked out at ${new Date(a.out_time).toLocaleTimeString()}`;
            hoursStatus.textContent = `Hours Today: ${formatHM(a.worked_seconds || 0)}`;
            btnAttendance.disabled = true;                             // üîí lock after marked
            btnAttendance.textContent = "‚úÖ Attendance Marked";
            return;
          }
        }catch(e){
          console.warn(e);
        }
      }

      // ---- Attendance button (idempotent UI) ----
      btnAttendance.addEventListener("click", async () => {
        if (btnAttendance.disabled) return;
        btnAttendance.disabled = true;
        const old = btnAttendance.textContent;
        btnAttendance.textContent = "‚è≥ Updating‚Ä¶";
        uiMsg.textContent = ""; uiMsg.className = "note";
        try{
          const res = await fetch(`/telecaller/attendance`, {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ telecaller_id: telecallerId, timestamp: new Date().toISOString() })
          });
          if (!res.ok) throw new Error("Failed to add attendance");
          const data = await res.json();

          if (data.status === "clocked_in"){
            attendanceStatus.textContent = `Attendance: clocked in at ${new Date(data.in_time).toLocaleTimeString()}`;
            startLiveTimerFrom(data.in_time);
            btnAttendance.textContent = "‚úÖ Attendance Marked";
            btnAttendance.disabled = true;                              // üîí lock
          } else if (data.status === "already_marked"){
            await refreshTodayHours();
            btnAttendance.textContent = "‚úÖ Attendance Already Marked";
            btnAttendance.disabled = true;                              // üîí lock
          } else if (data.status === "clocked_out"){
            clearHoursTimer();
            attendanceStatus.textContent = `Attendance: clocked out at ${new Date(data.out_time).toLocaleTimeString()}`;
            const secs = data.worked_seconds || 0;
            hoursStatus.textContent = `Hours Today: ${formatHM(secs)}`;
            btnAttendance.textContent = "‚úÖ Attendance Marked";
            btnAttendance.disabled = true;                              // üîí lock
          } else {
            // Fallback
            await refreshTodayHours();
          }
        }catch(e){
          console.error(e);
          uiMsg.className = "error";
          uiMsg.textContent = "Attendance: error marking. Try again.";
          btnAttendance.textContent = old;
          btnAttendance.disabled = false;
        }
      });

      // ---- Live Location button ----
      btnLocation.addEventListener("click", async () => {
        uiMsg.className = "note";
        uiMsg.textContent = "";
        if (!("geolocation" in navigator)){
          uiMsg.className = "error";
          uiMsg.textContent = "Geolocation not supported on this browser/device.";
          return;
        }
        btnLocation.disabled = true;
        const old = btnLocation.textContent;
        btnLocation.textContent = "‚è≥ Getting location‚Ä¶";

        navigator.geolocation.getCurrentPosition(async (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          try{
            const res = await fetch(`/telecaller/live-location`, {
              method:"POST", headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ telecaller_id: telecallerId, lat: latitude, lng: longitude, accuracy, timestamp: new Date().toISOString() })
            });
            if (!res.ok) throw new Error("Failed to share location");
            await res.json();
            locationStatus.textContent = `Location: shared at ${new Date().toLocaleTimeString()}`;
            btnLocation.textContent = "üìç Location Shared";
          }catch(e){
            console.error(e);
            uiMsg.className = "error";
            uiMsg.textContent = "Location: error sharing. Try again.";
            btnLocation.textContent = old;
          }finally{
            btnLocation.disabled = false;
          }
        }, (err) => {
          console.warn(err);
          uiMsg.className = "error";
          uiMsg.textContent = "Location permission denied or unavailable.";
          btnLocation.textContent = old;
          btnLocation.disabled = false;
        }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
      });

      // ---- Quick nav to My Leads ----
      openMyLeadsBtn.addEventListener("click", () => {
        const stage = stageFilter.value || "";
        const q = encodeURIComponent(searchBox.value || "");
        window.location.href = `./my_leads.html?telecallerId=${telecallerId}&stage=${stage}&q=${q}`;
      });

      // Initial
      refreshTodayHours();
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") refreshTodayHours();
      });
    });
  </script>
</body>
</html>

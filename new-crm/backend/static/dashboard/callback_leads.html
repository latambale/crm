<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Callback Leads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../config.js"></script>
  <style>
    :root{--bg1:#f5d1ff;--bg2:#c1eaff;--card:linear-gradient(145deg,#fff,#f0f8ff);
      --accent:#5e35b1;--btn:linear-gradient(145deg,#f271c4,#aa52f2);--text:#333}
    *{box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0}
    body{min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));
      display:grid;grid-template-columns:260px 1fr}
    .sidebar{position:sticky;top:0;height:100vh;padding:1rem;background:var(--card);
      border-right:1px solid rgba(0,0,0,.05);box-shadow:0 10px 25px rgba(0,0,0,.08)}
    .brand{display:flex;align-items:center;gap:.6rem;margin-bottom:1rem}
    .logo{width:40px;height:40px;border-radius:12px;background:var(--btn);box-shadow:0 6px 14px rgba(0,0,0,.15)}
    .brand h1{font-size:1.1rem;color:var(--accent);text-shadow:1px 1px 0 #fff}
    .nav{display:grid;gap:.4rem;margin-top:.5rem}
    .nav a{display:block;text-decoration:none;color:var(--text);font-weight:600;padding:.75rem .9rem;border-radius:.9rem;transition:.12s}
    .nav a:hover{background:#eef3ff;transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.06)}
    .logout{color:#b00020!important}

    .main{padding:1.2rem;display:grid;gap:1rem;align-content:start;min-width:0;overflow:auto}
    .header{background:var(--card);border-radius:1.6rem;padding:1rem 1.25rem;box-shadow:0 10px 25px rgba(0,0,0,.15);
      display:flex;justify-content:space-between;align-items:center;gap:.75rem;flex-wrap:wrap}
    .header h2{color:var(--accent);font-size:1.3rem;text-shadow:1px 1px 0 #fff}
    .pill{padding:.35rem .75rem;border-radius:999px;background:#f0e7ff;color:var(--accent);font-weight:600;font-size:.9rem}

    .card{background:var(--card);border-radius:1.2rem;padding:1rem 1.25rem;box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .filters{display:flex;gap:.6rem;flex-wrap:wrap}
    select,.input{background:#fff;border:none;border-radius:12px;padding:.6rem .75rem;min-width:180px;
      box-shadow:inset 2px 2px 6px #d1d9e6,inset -2px -2px 6px #fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;background:var(--btn);color:#fff;border:0;border-radius:999px;padding:.55rem .9rem;font-weight:700;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.2);transition:.12s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center;border:1px solid #eef; border-radius:12px;padding:.6rem .75rem;margin-top:.6rem;background:#f9fbff}
    .meta{font-size:.92rem;color:#444}
    .lead{font-weight:700}
    .note{font-size:.9rem;color:#555}
    .actions{display:flex;gap:.4rem;flex-wrap:wrap}
    .muted{color:#666}
    .ok{color:#087f23}
    .err{color:#b00020}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:50}
    .modal.open{display:grid}
    .modal-card{background:#fff;border-radius:14px;min-width:280px;max-width:420px;width:92vw;padding:1rem;box-shadow:0 20px 45px rgba(0,0,0,.25)}
    .modal-card h3{color:var(--accent);margin-bottom:.6rem}
    .field{display:grid;gap:.35rem;margin-top:.6rem}
    .field input,.field textarea{border:none;border-radius:12px;padding:.6rem .75rem;background:#f5f7ff;
      box-shadow:inset 2px 2px 6px #d1d9e6,inset -2px -2px 6px #fff}
    .modal-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:.8rem}
    .ghost{background:#e7e7ff;color:#333}
    @media (max-width:980px){
      body{grid-template-columns:1fr}
      .sidebar{position:fixed;left:0;top:0;transform:translateX(-100%);transition:transform .2s ease;z-index:20;width:260px}
      .sidebar.open{transform:translateX(0)}
      .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:15}
      .overlay.show{display:block}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand"><div class="logo"></div><h1>BrokerBuddy</h1></div>
    <nav class="nav">
      <a href="./telecaller_dashboard.html">üè† Dashboard</a>
      <a href="./telecaller.html">‚ñ∂ Start Calling</a>
      <a href="./callback_leads.html"><strong>‚è∞ CallBack Leads</strong></a>
      <a href="./svs_leads.html">üìç SVS Leads</a>
      <a href="./my_leads.html">üë§ My Leads</a>
      <a href="./upload_docs.html">üì∑ Upload Document/Location Selfie</a>
      <a href="./add_project.html">‚ûï Add Projects</a>
      <a href="./projects.html">üèóÔ∏è View Active Projects</a>
      <a href="./payslips.html">üíº Download PaySlips</a>
      <a class="logout" href="/logout">‚á¶ Logout</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <section class="header">
      <h2>Callback Leads</h2>
      <span class="pill" id="tcInfo"></span>
    </section>

    <section class="card">
      <div class="filters">
        <select id="scope">
          <option value="today">Today</option>
          <option value="overdue">Overdue</option>
          <option value="upcoming">Upcoming</option>
          <option value="all">All</option>
        </select>
        <select id="status">
          <option value="pending">Pending</option>
          <option value="done">Done</option>
          <option value="canceled">Canceled</option>
          <option value="all">All statuses</option>
        </select>
        <input id="q" class="input" placeholder="Search name / phone / note" />
        <button class="btn" id="refreshBtn">Refresh</button>
      </div>

      <div id="list"></div>
      <p class="muted" id="empty" style="display:none;margin-top:.8rem;">No callbacks in this view.</p>
      <p id="msg" class="muted" style="margin-top:.6rem;"></p>
    </section>
  </main>

  <!-- Reschedule Modal -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <h3>Reschedule Callback</h3>
      <div class="field">
        <label for="dueAt">Date & Time</label>
        <input type="datetime-local" id="dueAt">
      </div>
      <div class="field">
        <label for="note">Note (optional)</label>
        <textarea id="note" rows="3" placeholder="Add a short note..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="cancelModal">Cancel</button>
        <button class="btn" id="saveModal">Save</button>
      </div>
    </div>
  </div>

  <script>
    const url = new URLSearchParams(location.search);
    const telecallerId = parseInt(url.get("telecallerId")) || parseInt(localStorage.getItem("telecallerId")) || 3;
    localStorage.setItem("telecallerId", telecallerId);

    const scopeEl = document.getElementById("scope");
    const statusEl = document.getElementById("status");
    const qEl = document.getElementById("q");
    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");
    const msgEl = document.getElementById("msg");
    const tcInfo = document.getElementById("tcInfo");

    // Modal elements
    const modal = document.getElementById("modal");
    const dueAtInput = document.getElementById("dueAt");
    const noteInput = document.getElementById("note");
    const cancelModal = document.getElementById("cancelModal");
    const saveModal = document.getElementById("saveModal");
    let editingId = null;

    tcInfo.textContent = `Telecaller #${telecallerId}`;

    function zToLocalISO(zstr){
      // convert "2025-08-12T19:00:00Z" to "YYYY-MM-DDTHH:mm" in local time (for datetime-local)
      const d = new Date(zstr);
      const pad = n => String(n).padStart(2,"0");
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth()+1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function fmt(zstr){
      const d = new Date(zstr);
      return d.toLocaleString();
    }

    function openModal(cb){
      editingId = cb.id;
      dueAtInput.value = zToLocalISO(cb.due_at);
      noteInput.value = cb.note || "";
      modal.classList.add("open");
    }
    function closeModal(){
      modal.classList.remove("open");
      editingId = null;
      noteInput.value = "";
    }
    cancelModal.onclick = closeModal;

    async function fetchList(){
      msgEl.textContent = "";
      listEl.innerHTML = "";
      emptyEl.style.display = "none";

      const scope = scopeEl.value;
      const status = statusEl.value;
      const res = await fetch(`/telecaller/callbacks/${telecallerId}?scope=${scope}&status=${status}`);
      if (!res.ok){ msgEl.textContent = "Failed to load callbacks."; return; }
      let rows = await res.json();

      // client search
      const q = (qEl.value || "").toLowerCase().trim();
      if (q){
        rows = rows.filter(r =>
          (r.lead_name || "").toLowerCase().includes(q) ||
          (r.lead_phone || "").toLowerCase().includes(q) ||
          (r.note || "").toLowerCase().includes(q)
        );
      }

      if (!rows.length){
        emptyEl.style.display = "block";
        return;
      }

      for (const r of rows){
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="meta">
            <div class="lead">${r.lead_name || "Unknown"} ‚Äî ${r.lead_phone || ""}</div>
            <div class="note">${r.note ? r.note : "<span class='muted'>(no note)</span>"}</div>
            <div class="muted">Due: ${fmt(r.due_at)} | Status: ${r.status}</div>
          </div>
          <div class="actions">
            <a class="btn" href="tel:${r.lead_phone || ""}">üìû Call</a>
            <button class="btn" data-action="resched" data-id="${r.id}">üóìÔ∏è Reschedule</button>
            <button class="btn" data-action="done" data-id="${r.id}">‚úÖ Done</button>
            <button class="btn" data-action="cancel" data-id="${r.id}">‚úñ Cancel</button>
          </div>
        `;
        listEl.appendChild(row);
      }
    }

    // List actions (event delegation)
    listEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      if (!id || !action) return;

      try{
        if (action === "resched"){
          // Load row data to prefill
          const item = [...listEl.querySelectorAll("button[data-id]")].find(b => b.getAttribute("data-id")===id);
          // We already have the due_at/note in DOM? For simplicity refetch list and pick the one.
          const res = await fetch(`/telecaller/callbacks/${telecallerId}?scope=all&status=all`);
          const rows = await res.json();
          const cb = rows.find(x => String(x.id) === String(id));
          if (!cb){ msgEl.textContent = "Item not found."; return; }
          openModal(cb);
          saveModal.onclick = async () => {
            const dueLocal = dueAtInput.value; // "YYYY-MM-DDTHH:mm" local
            if (!dueLocal){ alert("Please pick date/time"); return; }
            const dueIsoLocal = new Date(dueLocal).toISOString(); // send as UTC ISO
            const note = noteInput.value || "";
            const res2 = await fetch(`/telecaller/callback/${id}`, {
              method: "PUT", headers: {"Content-Type":"application/json"},
              body: JSON.stringify({ due_at: dueIsoLocal, note })
            });
            if (!res2.ok){ alert("Failed to reschedule"); return; }
            closeModal();
            fetchList();
          };
        }
        if (action === "done"){
          const res = await fetch(`/telecaller/callback/${id}/done`, { method: "PUT" });
          if (!res.ok){ alert("Failed to mark done"); return; }
          fetchList();
        }
        if (action === "cancel"){
          const ok = confirm("Cancel this callback?");
          if (!ok) return;
          const res = await fetch(`/telecaller/callback/${id}`, {
            method: "PUT", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ status: "canceled" })
          });
          if (!res.ok){ alert("Failed to cancel"); return; }
          fetchList();
        }
      }catch(err){
        console.error(err);
        msgEl.textContent = "Action failed.";
      }
    });

    document.getElementById("refreshBtn").onclick = fetchList;
    scopeEl.onchange = fetchList;
    statusEl.onchange = fetchList;
    qEl.oninput = () => { clearTimeout(window._t); window._t = setTimeout(fetchList, 250); };

    // Initial load
    fetchList();
  </script>
</body>
</html>

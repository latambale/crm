<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="../config.js"></script>
  <style>
    :root{--bg1:#f5d1ff;--bg2:#c1eaff;--card:linear-gradient(145deg,#fff,#f0f8ff);
      --accent:#5e35b1;--btn:linear-gradient(145deg,#f271c4,#aa52f2);--text:#333}
    *{box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0}
    body{min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));
      display:grid;grid-template-columns:260px 1fr}
    .sidebar{position:sticky;top:0;height:100vh;padding:1rem;background:var(--card);
      border-right:1px solid rgba(0,0,0,.05);box-shadow:0 10px 25px rgba(0,0,0,.08)}
    .brand{display:flex;align-items:center;gap:.6rem;margin-bottom:1rem}
    .logo{width:40px;height:40px;border-radius:12px;background:var(--btn);box-shadow:0 6px 14px rgba(0,0,0,.15)}
    .brand h1{font-size:1.1rem;color:var(--accent);text-shadow:1px 1px 0 #fff}
    .nav{display:grid;gap:.4rem;margin-top:.5rem}
    .nav a{display:block;text-decoration:none;color:var(--text);font-weight:600;padding:.75rem .9rem;border-radius:.9rem;transition:.12s}
    .nav a:hover{background:#eef3ff;transform:translateY(-1px);box-shadow:0 4px 10px rgba(0,0,0,.06)}
    .nav a strong{color:var(--accent)}
    .logout{color:#b00020!important}

    .main{padding:1.2rem;display:grid;gap:1rem;align-content:start;min-width:0;overflow:auto}
    .header{background:var(--card);border-radius:1.6rem;padding:1rem 1.25rem;box-shadow:0 10px 25px rgba(0,0,0,.15);
      display:flex;justify-content:space-between;align-items:center;gap:.75rem;flex-wrap:wrap}
    .header h2{color:var(--accent);font-size:1.3rem;text-shadow:1px 1px 0 #fff}
    .pill{padding:.35rem .75rem;border-radius:999px;background:#f0e7ff;color:var(--accent);font-weight:600;font-size:.9rem}

    .card{background:var(--card);border-radius:1.2rem;padding:1rem 1.25rem;box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .grid{display:grid;gap:1rem;grid-template-columns:repeat(12,1fr)}
    .section{grid-column:span 12}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:.8rem}
    .field{grid-column:span 12;display:grid;gap:.35rem}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
    label{font-weight:700;color:#444}
    input, select, textarea{
      background:#fff;border:none;border-radius:12px;padding:.6rem .75rem;
      box-shadow:inset 2px 2px 6px #d1d9e6,inset -2px -2px 6px #fff;font-size:.95rem
    }
    textarea{min-height:90px;resize:vertical}
    .hint{font-size:.86rem;color:#666}
    .muted{color:#666}

    .chips{display:flex;flex-wrap:wrap;gap:.4rem;background:#f5f7ff;border-radius:12px;padding:.5rem;
      box-shadow:inset 2px 2px 6px #d1d9e6,inset -2px -2px 6px #fff}
    .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.35rem .6rem;border-radius:999px;background:#eef3ff;font-weight:600}
    .chip button{border:0;background:transparent;cursor:pointer;font-size:1rem}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;background:var(--btn);color:#fff;border:0;border-radius:999px;padding:.7rem 1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.2);transition:.12s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(0,0,0,.25)}
    .ghost{background:#e7e7ff;color:#333}

    .area-list{display:grid;gap:.5rem}
    .area-row{display:grid;grid-template-columns:1fr repeat(2,120px) auto;gap:.5rem;align-items:end}
    .area-row label{font-weight:600}
    .area-row .x{background:#fff;border:0;border-radius:10px;padding:.4rem .6rem;cursor:pointer}

    .msg{font-weight:600}
    .ok{color:#137333}
    .err{color:#b00020}

    @media (max-width:980px){
      body{grid-template-columns:1fr}
      .sidebar{position:fixed;left:0;top:0;transform:translateX(-100%);transition:transform .2s ease;z-index:20;width:260px}
      .sidebar.open{transform:translateX(0)}
      .area-row{grid-template-columns:1fr 1fr 1fr auto}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand"><div class="logo"></div><h1>BrokerBuddy</h1></div>
    <nav class="nav">
      <a href="./telecaller_dashboard.html">üè† Dashboard</a>
      <a href="./telecaller.html">‚ñ∂ Start Calling</a>
      <a href="./callback_leads.html">‚è∞ CallBack Leads</a>
      <a href="./svs_leads.html">üìç SVS Leads</a>
      <a href="./my_leads.html">üë§ My Leads</a>
      <a href="./upload_docs.html">üì∑ Upload Document/Location Selfie</a>
      <a href="./add_project.html"><strong>‚ûï Add Projects</strong></a>
      <a href="./projects.html">üèóÔ∏è View Active Projects</a>
      <a href="./payslips.html">üíº Download PaySlips</a>
      <a class="logout" href="/logout">‚á¶ Logout</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <section class="header">
      <h2>Add Project</h2>
      <span class="pill" id="tcInfo"></span>
    </section>

    <section class="card">
      <div class="grid">
        <!-- Basic Details -->
        <div class="section">
          <h3 style="color:var(--accent);margin-bottom:.6rem">Basic Details</h3>
          <div class="row">
            <div class="field col-6">
              <label>Project Name *</label>
              <input id="name" placeholder="e.g., Skyline Towers">
            </div>

            <div class="field col-6">
              <label>Location *</label>
              <select id="location">
                <option value="">Select...</option>
                <option>Wakad</option><option>Baner</option><option>Balewadi</option>
                <option>Hinjewadi</option><option>Aundh</option><option>Kharadi</option>
                <option>Viman Nagar</option><option>Ravet</option><option>Other</option>
              </select>
              <input id="location_other" placeholder="Enter location" style="display:none;margin-top:.4rem">
            </div>

            <div class="field col-4">
              <label>Budget Range *</label>
              <div style="display:grid;grid-template-columns:1fr 1fr 110px;gap:.5rem">
                <input id="budget_min" type="number" min="0" placeholder="Min">
                <input id="budget_max" type="number" min="0" placeholder="Max">
                <select id="budget_unit">
                  <option value="L">Lakh</option>
                  <option value="Cr">Crore</option>
                </select>
              </div>
              <div class="hint">Saved as "minUnit-maxUnit" (e.g., 60L-90L)</div>
            </div>

            <div class="field col-8">
              <label>Description</label>
              <textarea id="description" placeholder="Short description..."></textarea>
            </div>
          </div>
        </div>

        <!-- Inventory & Carpet Areas -->
        <div class="section">
          <h3 style="color:var(--accent);margin-bottom:.6rem">Inventory & Carpet Areas</h3>

          <div class="row">
            <div class="field col-6">
              <label>Add Inventory Type</label>
              <div style="display:grid;grid-template-columns:1fr auto;gap:.5rem">
                <select id="invSelect">
                  <option value="">Select type...</option>
                  <option>1BHK</option><option>2BHK</option><option>3BHK</option>
                  <option>4BHK</option><option>Studio</option><option>Duplex</option>
                  <option>Penthouse</option><option>Villa</option><option>Plot</option>
                </select>
                <button class="btn" id="addInv">Add</button>
              </div>
              <div class="hint">`property_type` will automatically match selected inventory types.</div>
            </div>

            <div class="field col-6">
              <label>Property Type (auto)</label>
              <input id="property_type_display" readonly placeholder="Auto from inventory">
            </div>
          </div>

          <div class="field">
            <label>Per-Inventory Carpet Areas (sqft)</label>
            <div class="area-list" id="areaList">
              <!-- rows will be injected here -->
            </div>
            <div class="hint">Enter min/max carpet for each inventory. (No JSON needed.)</div>
          </div>
        </div>

        <!-- Developer & Specs -->
        <div class="section">
          <h3 style="color:var(--accent);margin-bottom:.6rem">Developer & Specs</h3>
          <div class="row">
            <div class="field col-4">
              <label>Developer Name</label>
              <input id="developer_name" placeholder="Developer">
            </div>
            <div class="field col-4">
              <label>Experience</label>
              <select id="experience">
                <option value="">Select...</option>
                <option>0-3 years</option><option>3-5 years</option><option>5-10 years</option>
                <option>10-20 years</option><option>20+ years</option>
              </select>
            </div>
            <div class="field col-4">
              <label>Completed Projects</label>
              <select id="completed_projects">
                <option value="">Select...</option>
                <option>0</option><option>1-5</option><option>6-10</option>
                <option>11-20</option><option>20+</option>
              </select>
            </div>

            <div class="field col-4">
              <label>Nearest Landmark</label>
              <input id="landmark" placeholder="Near ...">
            </div>
            <div class="field col-4">
              <label>Possession Type</label>
              <select id="possession_type">
                <option value="">Select...</option>
                <option>Ready</option>
                <option>Under Construction</option>
                <option>New Launch</option>
              </select>
            </div>
            <div class="field col-4">
              <label>Total Land</label>
              <div style="display:grid;grid-template-columns:1fr 110px;gap:.5rem">
                <input id="total_land_val" type="number" min="0" step="0.01" placeholder="e.g., 3">
                <select id="total_land_unit"><option>acres</option><option>sqft</option><option>hectares</option></select>
              </div>
            </div>

            <div class="field col-3">
              <label>Total Towers</label>
              <input id="total_towers" type="number" min="0" placeholder="e.g., 6">
            </div>
            <div class="field col-3">
              <label>Floors</label>
              <input id="number_of_floors" type="number" min="0" placeholder="e.g., 22">
            </div>
            <div class="field col-3">
              <label>Construction Technology</label>
              <select id="construction_technology">
                <option value="">Select...</option>
                <option>Mivan</option><option>Precast</option><option>RCC</option><option>Conventional</option>
              </select>
            </div>
            <div class="field col-3">
              <label># Amenities</label>
              <input id="number_of_amenities" type="number" min="0" placeholder="e.g., 25">
            </div>

            <div class="field col-4">
              <label>Flats per Floor</label>
              <input id="flats_per_floor" type="number" min="0" placeholder="e.g., 4">
            </div>
            <div class="field col-4">
              <label>Lifts</label>
              <input id="lifts" type="number" min="0" placeholder="e.g., 2">
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="section">
          <div style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center">
            <button class="btn" id="saveBtn">Save Project</button>
            <button class="btn ghost" id="resetBtn">Reset</button>
            <span id="msg" class="msg"></span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Telecaller badge (optional)
    const url = new URLSearchParams(location.search);
    const telecallerId = parseInt(url.get("telecallerId")) || parseInt(localStorage.getItem("telecallerId")) || 3;
    localStorage.setItem("telecallerId", telecallerId);
    document.getElementById("tcInfo").textContent = `Telecaller #${telecallerId}`;

    // Location "Other" toggle
    const locSel = document.getElementById("location");
    const locOther = document.getElementById("location_other");
    locSel.onchange = () => {
      if (locSel.value === "Other") { locOther.style.display = "block"; }
      else { locOther.style.display = "none"; locOther.value = ""; }
    };

    // Inventory + carpet areas
    const invSelect = document.getElementById("invSelect");
    const addInvBtn = document.getElementById("addInv");
    const areaList = document.getElementById("areaList");
    const propTypeDisplay = document.getElementById("property_type_display");

    // in-memory model
    // items = [{type:'2BHK', min: 650, max: 780}]
    let items = [];

    function renderAreas(){
      // update property_type (auto) as comma-joined types
      propTypeDisplay.value = items.map(i => i.type).join(", ");

      // rebuild rows
      areaList.innerHTML = "";
      if (!items.length){
        const p = document.createElement("p");
        p.className = "muted";
        p.textContent = "No inventory added yet.";
        areaList.appendChild(p);
        return;
      }

      items.forEach((it, idx) => {
        const row = document.createElement("div");
        row.className = "area-row";
        row.innerHTML = `
          <div>
            <label>${it.type}</label>
          </div>
          <div>
            <label>Carpet Min</label>
            <input type="number" min="0" step="1" placeholder="e.g., 650" value="${it.min ?? ""}" data-bind="min" data-idx="${idx}">
          </div>
          <div>
            <label>Carpet Max</label>
            <input type="number" min="0" step="1" placeholder="e.g., 780" value="${it.max ?? ""}" data-bind="max" data-idx="${idx}">
          </div>
          <div style="display:flex;justify-content:flex-end">
            <button class="x" title="Remove" data-del="${idx}">√ó</button>
          </div>
        `;
        areaList.appendChild(row);
      });
    }

    addInvBtn.onclick = (e) => {
      e.preventDefault();
      const v = (invSelect.value || "").trim();
      if (!v) return;
      if (items.some(i => i.type === v)) return; // ignore duplicates
      items.push({ type: v, min: "", max: "" });
      invSelect.selectedIndex = 0;
      renderAreas();
    };

    areaList.addEventListener("click", (e) => {
      const del = e.target.closest("button[data-del]");
      if (del){
        const idx = parseInt(del.getAttribute("data-del"), 10);
        items.splice(idx, 1);
        renderAreas();
      }
    });

    areaList.addEventListener("input", (e) => {
      const inp = e.target.closest("input[data-bind]");
      if (!inp) return;
      const idx = parseInt(inp.getAttribute("data-idx"), 10);
      const key = inp.getAttribute("data-bind");
      items[idx][key] = inp.value;
    });

    // Helpers
    function val(id){ return (document.getElementById(id).value || "").trim(); }
    function setMsg(txt, ok=false){ const m = document.getElementById("msg"); m.textContent = txt; m.className = "msg " + (ok ? "ok":"err"); }

    // Reset
    document.getElementById("resetBtn").onclick = (e)=>{
      e.preventDefault();
      ["name","description"].forEach(id => document.getElementById(id).value = "");
      locSel.selectedIndex = 0; locOther.value = ""; locOther.style.display = "none";
      ["budget_min","budget_max"].forEach(id => document.getElementById(id).value = "");
      document.getElementById("budget_unit").selectedIndex = 0;

      ["developer_name","landmark","total_towers","number_of_floors","number_of_amenities","flats_per_floor","lifts","total_land_val"].forEach(id=> document.getElementById(id).value="");
      ["experience","completed_projects","possession_type","construction_technology","total_land_unit"].forEach(id => document.getElementById(id).selectedIndex = 0);

      items = []; renderAreas();
      setMsg("");
    };

    // Save
    document.getElementById("saveBtn").onclick = async (e)=>{
      e.preventDefault();
      setMsg("");

      // required validations
      if (!val("name")) return setMsg("Project Name is required.");
      let location = locSel.value === "Other" ? val("location_other") : locSel.value;
      if (!location) return setMsg("Location is required.");

      if (!val("budget_min") || !val("budget_max")) return setMsg("Budget min & max are required.");
      const bmin = parseFloat(val("budget_min")), bmax = parseFloat(val("budget_max"));
      if (isNaN(bmin) || isNaN(bmax) || bmin <= 0 || bmax <= 0 || bmin > bmax) return setMsg("Budget values are invalid.");
      const budget_range = `${bmin}${val("budget_unit")}-${bmax}${val("budget_unit")}`;

      if (!items.length) return setMsg("Add at least one inventory type.");
      // at least ensure min <= max if both are present
      for (const it of items){
        const mi = parseFloat(it.min), ma = parseFloat(it.max);
        if (it.min && it.max && (isNaN(mi) || isNaN(ma) || mi > ma)){
          return setMsg(`Carpet range invalid for ${it.type}.`);
        }
      }

      // build carpet_area_json object from items
      const carpetObj = {};
      for (const it of items){
        const minStr = (it.min || "").trim();
        const maxStr = (it.max || "").trim();
        if (minStr && maxStr) carpetObj[it.type] = `${minStr}-${maxStr}`;
        else if (minStr) carpetObj[it.type] = `${minStr}`;
        else if (maxStr) carpetObj[it.type] = `${maxStr}`;
        else carpetObj[it.type] = ""; // still include type
      }

      // property_type auto from inventory
      const property_type = items.map(i => i.type).join(", ");

      // total land concat
      const tl_val = val("total_land_val");
      const total_land = tl_val ? `${tl_val} ${val("total_land_unit")}` : "";

      // payload matches your backend
      const payload = {
        name: val("name"),
        location,
        property_type,
        budget_range,
        description: val("description"),
        info: {
          developer_name: val("developer_name"),
          experience: val("experience"),
          completed_projects: val("completed_projects"),
          landmark: val("landmark"),
          possession_type: val("possession_type"),
          total_land,
          total_towers: val("total_towers"),
          number_of_floors: val("number_of_floors"),
          construction_technology: val("construction_technology"),
          number_of_amenities: val("number_of_amenities"),
          types_of_inventory: items.map(i => i.type),
          carpet_area_json: JSON.stringify(carpetObj),  // built from the fields (no manual JSON!)
          flats_per_floor: val("flats_per_floor"),
          lifts: val("lifts")
        }
      };

      try{
        const res = await fetch("/admin/project", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        if (!res.ok){ const t = await res.text(); throw new Error(t || "Request failed"); }
        const data = await res.json();
        setMsg(`‚úÖ Project created (ID: ${data.project_id})`, true);
      }catch(err){
        console.error(err);
        setMsg("‚ùå Failed to save project");
      }
    };

    // initial render
    renderAreas();
  </script>
</body>
</html>
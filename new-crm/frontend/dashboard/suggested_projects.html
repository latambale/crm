<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Suggested Projects</title>
  <style>
    /* üé® Base UI theme (unchanged from previous version) */
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #f5d1ff, #c1eaff);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .dashboard {
      background: linear-gradient(145deg, #ffffff, #f0f8ff);
      border-radius: 2rem;
      padding: 2.5rem;
      width: 100%;
      max-width: 900px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    h2 {
      text-align: center;
      font-size: 2rem;
      color: #5e35b1;
      text-shadow: 1px 1px 0 #ffffff;
      margin-bottom: 1.5rem;
    }

    #filterSection {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: space-between;
      background: #f0f4ff;
      padding: 1rem;
      border-radius: 1.5rem;
      box-shadow: inset 4px 4px 10px #d1d9e6, inset -4px -4px 10px #ffffff;
      margin-bottom: 2rem;
    }

    #filterSection label {
      flex: 1 1 30%;
      display: flex;
      flex-direction: column;
      font-weight: 500;
      color: #333;
    }

    #filterSection input {
      margin-top: 5px;
      padding: 0.8rem 1rem;
      border: none;
      border-radius: 1.5rem;
      background: #fff;
      box-shadow: inset 2px 2px 6px #d1d9e6, inset -2px -2px 6px #ffffff;
    }

    #filterSection button {
      flex: 1 1 100%;
      margin-top: 1rem;
      padding: 0.9rem;
      font-size: 1rem;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(145deg, #f271c4, #aa52f2);
      border: none;
      border-radius: 2rem;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    #filterSection button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    #projectList {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
    }

    .card {
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 1.5rem;
      box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.1),
                  -4px -4px 12px rgba(255, 255, 255, 0.6);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .card h3 {
      color: #6a1b9a;
      margin-bottom: 0.5rem;
    }

    .card p {
      margin: 0.3rem 0;
    }

    .card button {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      font-weight: bold;
      color: #fff;
      background: linear-gradient(145deg, #f271c4, #aa52f2);
      border: none;
      border-radius: 2rem;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    /* üóìÔ∏è Modal Styling */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 1.5rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 0.8rem 1rem;
      margin-bottom: 1rem;
      border: none;
      border-radius: 1.5rem;
      box-shadow: inset 2px 2px 6px #d1d9e6, inset -2px -2px 6px #ffffff;
    }

    .modal-content button {
      margin-top: 0.5rem;
      width: 48%;
    }

    .modal-content .actions {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <h2>Suggested Projects</h2>

    <div id="filterSection">
      <label>Property Type:
        <input id="typeFilter" placeholder="e.g. 2BHK">
      </label>
      <label>Budget:
        <input id="budgetFilter" placeholder="e.g. 60L-70L">
      </label>
      <label>Location:
        <input id="locationFilter" placeholder="e.g. Baner">
      </label>
      <button onclick="applyFilters()">Apply Filters</button>
    </div>

    <div id="projectList">Loading...</div>
  </div>

  <!-- üìÖ Modal for scheduling SVS -->
  <div class="modal" id="svsModal">
    <div class="modal-content">
      <h3>Schedule Site Visit</h3>
      <input type="datetime-local" id="visitDate" />
      <textarea id="visitNotes" placeholder="Any notes or preferences?"></textarea>
      <div class="actions">
        <button onclick="submitSVS()">Submit</button>
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const params       = new URLSearchParams(window.location.search);
    const leadId       = params.get("leadId");
    const leadIndex    = parseInt(params.get("leadIndex"))   || 0;
    const telecallerId = parseInt(params.get("telecallerId"))|| 3;

    let allProjects = [];
    let displayList = [];
    let selectedProjectId = null;

    async function fetchAllProjects() {
      const res = await fetch("http://127.0.0.1:8000/projects");
      allProjects = await res.json();
      await autoApplyLeadFilters();
    }

    async function autoApplyLeadFilters() {
      const leadRes = await fetch(`http://127.0.0.1:8000/lead-details/${leadId}`);
      const lead    = await leadRes.json();

      displayList = allProjects.filter(p =>
        p.type     === lead.looking_for &&
        p.budget   === lead.budget &&
        p.location === lead.location_preference
      );

      renderProjects(displayList.length ? displayList : allProjects, displayList.length === 0);
    }

    function applyFilters() {
      const type   = document.getElementById("typeFilter").value.toLowerCase();
      const budget = document.getElementById("budgetFilter").value.toLowerCase();
      const loc    = document.getElementById("locationFilter").value.toLowerCase();

      displayList = allProjects.filter(p =>
        p.type.toLowerCase().includes(type) &&
        p.budget.toLowerCase().includes(budget) &&
        p.location.toLowerCase().includes(loc)
      );

      renderProjects(displayList, false);
    }

    function renderProjects(list, showingAll) {
      const c = document.getElementById("projectList");
      if (list.length === 0) {
        c.innerHTML = "<p>No projects match these filters.</p>";
        return;
      }

      c.innerHTML =
        (showingAll ? "<p><em>No exact match ‚Äì listing all projects.</em></p>" : "") +
        list.map(p => `
          <div class="card">
            <h3>${p.name}</h3>
            <p><strong>Type:</strong> ${p.type}</p>
            <p><strong>Budget:</strong> ${p.budget}</p>
            <p><strong>Location:</strong> ${p.location}</p>
            <p>${p.desc}</p>
            <button onclick="openModal(${p.id})">üìç Schedule Site Visit</button>
          </div>`).join("");
    }

    function openModal(projectId) {
      selectedProjectId = projectId;
      document.getElementById("visitDate").value = "";
      document.getElementById("visitNotes").value = "";
      document.getElementById("svsModal").style.display = "flex";
    }

    function closeModal() {
      selectedProjectId = null;
      document.getElementById("svsModal").style.display = "none";
    }

    function submitSVS() {
      const date  = document.getElementById("visitDate").value;
      const notes = document.getElementById("visitNotes").value;

      if (!date) {
        alert("Please select a date and time.");
        return;
      }

      fetch("http://127.0.0.1:8000/sitevisit", {
        method : "POST",
        headers: { "Content-Type": "application/json" },
        body   : JSON.stringify({ lead_id: leadId, project_id: selectedProjectId, date, notes })
      })
      .then(r => {
        if (!r.ok) {
          alert("Failed to schedule site visit.");
          return;
        }
        alert("Site Visit Scheduled!");
        closeModal();
        window.location.href =
          `telecaller.html?leadIndex=${leadIndex + 1}&telecallerId=${telecallerId}`;
      });
    }

    fetchAllProjects();
  </script>
</body>
</html>
